<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Processing Article...</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container mt-5">
    <h3>Processing your article...</h3>

    <div class="progress my-4">
      <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
           role="progressbar" style="width: 10%">Starting...
      </div>
    </div>

    <p class="text-muted" id="statusDetail">Please wait while we process the file using OpenAI and fetch the image.</p>
  </div>

  <script>
    const steps = ["Reading file", "Calling OpenAI", "Formatting", "Searching image", "Complete"];
    const jobId = "{{ id }}";

    function updateProgress(status) {
      const index = steps.indexOf(status);
      const percent = index >= 0 ? ((index + 1) / steps.length) * 100 : 10;
      const bar = document.getElementById("progressBar");

      bar.style.width = percent + "%";
      bar.textContent = status;
    }

    function pollStatus() {
      fetch(`/status/${jobId}`)
        .then(res => res.json())
        .then(data => {
          const status = data.status;

          if (status.startsWith("Error")) {
            const bar = document.getElementById("progressBar");
            bar.classList.remove("progress-bar-animated");
            bar.classList.add("bg-danger");
            bar.textContent = status;

            document.getElementById("statusDetail").textContent =
              "An error occurred during processing. Please go back and try again.";
          } else if (status === "Complete") {
            window.location.href = `/article/${jobId}`;
          } else {
            updateProgress(status);
            setTimeout(pollStatus, 1000);
          }
        })
        .catch(error => {
          console.error("Error polling status:", error);
          document.getElementById("statusDetail").textContent =
            "Connection lost. Please reload the page.";
        });
    }

    // Start job and begin polling
    fetch(`/run/${jobId}`);
    pollStatus();
  </script>
</body>
</html>