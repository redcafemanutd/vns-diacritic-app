<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Processed Articles</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container mt-5">
    <h2 class="mb-4">Processed Articles</h2>

    <table class="table table-bordered table-hover bg-white">
      <thead class="table-light">
        <tr>
          <th>#</th>
          <th>Filename</th>
          <th>Status</th>
          <th>Progress</th>
          <th>Result</th>
        </tr>
      </thead>
      <tbody>
        {% for article in articles %}
        <tr id="row-{{ article.id }}">
          <td>{{ loop.index }}</td>
          <td>{{ article.filename }}</td>
          <td id="status-{{ article.id }}">{{ article.status }}</td>
          <td>
            <div class="progress">
              <div id="bar-{{ article.id }}" class="progress-bar progress-bar-striped progress-bar-animated"
                   style="width: 10%">Waiting...
              </div>
            </div>
          </td>
          <td>
            <a id="view-{{ article.id }}" class="btn btn-sm btn-success disabled" href="/article/{{ article.id }}" target="_blank">
              View
            </a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <a href="{{ url_for('index') }}" class="btn btn-secondary mt-4">‚Üê Back to Upload</a>
  </div>

  <script>
    const steps = ["Reading file", "Calling OpenAI", "Formatting", "Searching image", "Complete"];

    const articleIds = JSON.parse('{{ articles | map(attribute="id") | list | tojson | safe }}');

    function pollStatus(id) {
      fetch(`/status/${id}`)
        .then(res => res.json())
        .then(data => {
          const status = data.status;
          document.getElementById(`status-${id}`).textContent = status;

          const bar = document.getElementById(`bar-${id}`);
          const viewBtn = document.getElementById(`view-${id}`);

          if (status.startsWith("Error")) {
            bar.classList.remove("progress-bar-animated");
            bar.classList.add("bg-danger");
            bar.style.width = "100%";
            bar.textContent = status;
          } else if (status === "Complete") {
            bar.classList.remove("progress-bar-animated");
            bar.classList.add("bg-success");
            bar.style.width = "100%";
            bar.textContent = "Done!";
            viewBtn.classList.remove("disabled");
          } else {
            const index = steps.indexOf(status);
            const percent = index >= 0 ? ((index + 1) / steps.length) * 100 : 10;
            bar.style.width = percent + "%";
            bar.textContent = status;
            setTimeout(() => pollStatus(id), 1000);
          }
        });
    }

    // Launch processing + polling for each article
    for (const id of articleIds) {
      fetch(`/status/${id}`)
        .then(res => res.json())
        .then(data => {
          if (data.status === "Starting...") {
            fetch(`/run/${id}`);
          }
          pollStatus(id);
        });
    }
  </script>
</body>
</html>
